### **Project Brief: "Eversummer Days" (Working Title) - Revision 4**

**Game Premise:**
*   **Genre:** 2D, Tile-Based, Hybrid Turn-Based Tactical RPG.
*   **Core Philosophy:** A "Fantasy World Simulator" that prioritizes deep, systemic interactivity and emergent gameplay over a linear, scripted narrative. The goal is a highly faithful digital adaptation of the D&D 3.5e OGL ruleset.
*   **Inspiration:** The mechanical depth and rule-based world of **Dungeons & Dragons 3.5e OGL**, the strategic, systems-driven combat of **Incursion: Halls of the Goblin King**, and the profound emergent interactions and player freedom of **NetHack**.
*   **Setting:** A setting-agnostic fantasy world, intentionally designed as a blank canvas for community-driven content.
*   **Core Gameplay Loop:** Explore dangerous environments, overcome challenges using a wide array of tactical actions and items, engage in turn-based combat governed by a strict ruleset (including flanking and attacks of opportunity), and develop unique characters through a class-based system.

**High-Level Objectives:**
1.  **Build a Systems-First Engine:** The primary goal is to create a robust, bespoke game engine in TypeScript that simulates a fantasy world governed by consistent, interlocking rules. The story and quests are secondary to the quality of the simulation.
2.  **Embrace Emergent Gameplay:** The engine will not script specific outcomes. Instead, it will provide a toolbox of universal actions (`Use`, `Equip`, `Attack`) and a rich set of object properties (tags, materials, curses, magical enchantments). The "gameplay" will emerge from the logical and often surprising interactions between these systems.
3.  **True Plug-and-Play Moddability:** The engine must be a **rules-agnostic interpreter**. Users must be able to add new races, classes, items, spells, and even fundamental game mechanics by simply adding data (`.json`) and logic (`.mjs`) files, without ever recompiling the core engine.
4.  **Flexible Content Generation:** The engine must support both handcrafted, static maps for authored experiences and procedural dungeon generation for infinite replayability, allowing content creators to blend both approaches within a single campaign.

**Key Design Concepts & Technical Requirements:**
*   **Architectural Pillars:**
    *   **Data-Driven Logic with Scripting Hooks:** The engine must favor a declarative approach, avoiding hardcoded behaviors wherever possible. Core logic should be defined in data (.json files), with complex, unique behaviors implemented in companion script files (.mjs). This ensures the engine's hardcoded systems remain generic and reusable, maximizing modability for all features and content.
    *   **Service Locator:** A single, global point of access for all engine systems and the game state, ensuring controlled, explicit dependencies.
    *   **Event Bus:** A central nervous system for decoupled communication, allowing systems to react to game events (like `action:move:provokes_aoo`) without direct knowledge of one another.
    *   **Hybrid Turn System:** A stateful `TurnManager` that seamlessly transitions between real-time "Exploration Mode" and a strict, initiative-based "Combat Mode," correctly handling out-of-turn actions like Attacks of Opportunity.
    *   **Modifier Pipeline:** A sophisticated system (`ModifierManager`, `ModifierList`) for calculating all rolls and statistics by applying `Modifiers` of different types (`racial`, `armor`, `competence`, `untyped`), correctly handling D&D's complex bonus stacking and capping (e.g., Max DEX Bonus) rules.
    *   **Global Tagging System:** A universal metadata system (`tags: string[]`) on all content items and instances to drive rules, validation, and emergent interactions.
*   **Combinatorial Item System:** Items are generated by combining a **base item** (`longsword.json`) with one or more **magic properties** (`flaming.json`, `+1.json`) and **materials** (`adamantine.json`). A `LootFactory` is responsible for this procedural generation, creating immense variety from a small set of data files.
*   **Modular AI with Behavioral Flags:** AI is not monolithic. A single, powerful AI Package acts as a "behavior runner." Monster prefabs specify a list of behavioral flags (`ai_flags: ["FLEER", "ARCHER"]`) that dictate which reusable AI subroutines the runner should execute, allowing for complex AI composition through data.
*   **Unified Entity Model:** All characters (PCs and NPCs) are built from the same fundamental `Entity` class and share the same components (`InventoryComponent`, `EquipmentComponent`), ensuring rules consistency.
*   **Rendering:** An initial ASCII/character-based rendering on HTML5 Canvas, driven by a `Renderable` component for maximum flexibility and decoupling.

---

### **Implementation Checklist: The Path to MVP and Beyond (Revision 6)**

#### **Phase 0: Architecture Complete**
*   `[x]` **Implement the Global Tagging System.**
*   `[x]` **Build the Core `RulesEngine` Service.**
*   `[x]` **Implement the Service Locator Pattern.**
*   `[x]` **Decouple and Refactor the UI.**
*   `[x]` **Implement the `Renderable` Component.**
*   `[x]` **Unify NPCs with an `NpcFactory`.**
*   `[x]` **Build the `TurnManager`.**
*   `[x]` **Implement Full Feat & Ability Application.**
*   `[x]` **Formalize the Action Economy.**
*   `[x]` **Task 0.1: Centralize Internal Engine Event Strings.**
    *   **Status:** Done. Created `src/scripts/engine/events.mts` and refactored all engine and UI code to use the new `GameEvents` constants instead of raw strings.
*   `[x]` **Task 0.2: Implement the Modifier Pipeline (`ModifierManager`).**
    *   **Guidance:** Create a system to manage and apply `Modifiers` from all sources, correctly handling D&D 3.5e's complex stacking and layering rules.
    *   `[x]` **Sub-task 0.2.1:** Establish a layered calculation order: apply base/inherent stats first, then persistent modifiers from equipment, and finally temporary effects from spells or conditions.
    *   `[x]` **Sub-task 0.2.2:** Implement a data-driven system for modifier types. Instead of hardcoding behavior, define types (`enhancement`, `racial`, `dodge`, etc.) in data files. Each definition should specify its stacking behavior (e.g., `stacking: 'highest'`, `stacking: 'sum'`) and other rules.
    *   `[x]` **Sub-task 0.2.3:** Implement duration tracking for temporary effects (rounds, minutes, hours) and ensure they are removed upon expiration.
*   `[x]` **Task 0.3: Implement the Core Event Bus.**
    *   **Guidance:** Build the central event dispatch system that allows for decoupled communication between game components, as described in the brief.
*   `[x]` **Task 0.4: Refactor Content Loading for `modifier_types.json`.**
    *   **Status:** Done. `modifier_types.json` is now loaded via `ContentLoader` and managed by `ModifierManager`, removing direct file system imports.

---
#### **Phase 1: Character & Action Systems Online**
*   `[x]` **Action Economy Framework Established.**
*   `[x]` **"Attack" Action Chain Implemented.**
*   `[x]` **Full Damage Calculation Implemented.**
*   `[x]` **Critical Hits Implemented.**
*   `[x]` **Task 1.1: Initial AI System Refactor.**
*   `[x]` **Movement Point System Implemented.**
    *   **Status:** Done. The `TurnManager` now grants movement points, and the `RulesEngine` deducts them based on tile cost.

---
#### **Phase 2: Deep Equipment & Itemization (Revised)**
*   `[x]` **Task 2.1: Implement the Full Equipment System.**
*   `[x]` **Task 2.2: Implement Combinatorial Item Generation (`LootFactory`).**
*   `[x]` **Task 2.3: Implement the "Use Item" Action.**
    *   `[x]` **Sub-task 2.3.1:** Define "Use Item" as a Standard Action by default (e.g., drinking a potion, reading a scroll).
    *   `[x]` **Sub-task 2.3.2:** Implement logic for item uses that provoke Attacks of Opportunity (AoOs), such as drinking a potion or applying an oil.
    *   `[x]` **Sub-task 2.3.3:** Differentiate activation types (Spell Completion, Command Word, Use-Activated) and ensure they do not provoke AoOs unless specified.
*   `[x]` **Task 2.4: Implement Item Identification.**
    *   **Status:** Done. The `RulesEngine` now handles the `Spellcraft` skill to identify items, changing their state.
*   `[x]` **Task 2.5: Implement Item States via Tags.** (e.g., `[state:cursed]`, `[state:identified]`, `[state:broken]`)
    *   **Status:** Done. The `LootFactory` now correctly applies the `[state:unidentified]` tag to magical items, and the `InventoryView` has been updated to conditionally display item information and actions based on this tag.
*   `[x]` **Task 2.6: Design and Implement the Unified Effect System.**
    *   `[x]` **Sub-task 2.6.1:** Create a generic, data-driven `Effect` object structure.
    *   `[x]` **Sub-task 2.6.2:** Refactor item definitions to point to reusable `Effect` objects.
*   `[x]` **Task 2.7: Implement Data-Driven Skill System.**
    *   `[x]` **Sub-task 2.7.1:** Create JSON definitions for skills with `active_uses`.
    *   `[x]` **Sub-task 2.7.2:** Implement `RulesEngine.resolveSkillUse` to interpret skill JSON.
*   `[x]` **Task 2.8: Implement `UseSkillAction`.**
    *   `[x]` **Sub-task 2.8.1:** Create the generic `UseSkillAction`.
    *   `[x]` **Sub-task 2.8.2:** Integrate the action with the UI.

---
#### **Phase 3: Advanced Combat Tactics (Revised)**
*   `[ ]` **Task 3.0: Implement Player-Prompted Interrupt System.**
    *   **Description:** Implement a generic, event-driven system to manage all out-of-turn actions (including Attacks of Opportunity, Immediate Actions, etc.). This system must be capable of pausing the game state, prompting the player for a decision when an opportunity to act arises, and then executing the chosen action before resuming the normal turn order. This is a foundational system for advanced tactical play.
    *   `[ ]` **Sub-task 3.0.1: Create an Action Queue/Stack in `TurnManager`.**
        *   **Guidance:** The `TurnManager` must be refactored to manage a stack of actions rather than a single current action. This allows a new action (the interrupt) to be pushed on top of the stack, processed first, and then popped off to resume the original action.
    *   `[ ]` **Sub-task 3.0.2: Develop a generic `Interrupt` data structure.**
        *   **Guidance:** Define a standard format for an interrupt opportunity, e.g., `{ triggeringEvent: GameEvent, sourceEntity: Entity, potentialActions: Action[] }`. This structure will be passed from the rules engine to the UI.
    *   `[ ]` **Sub-task 3.0.3: Create a central `InterruptManager` service.**
        *   **Guidance:** This service will listen for all potentially interrupt-generating game events (e.g., `action:provokes_aoo`, `entity:takes_damage`). It will be responsible for checking if any entity has a relevant ability and, if that entity is the player, packaging the potential actions into an `Interrupt` object.
    *   `[ ]` **Sub-task 3.0.4: Implement the Player Prompt UI.**
        *   **Guidance:** The `UIManager` must be able to receive an `Interrupt` object and display a modal choice to the player (e.g., "Goblin provokes AoO. [Attack] [Decline]"). The UI will then send the player's chosen action (or a 'decline' signal) back to the `InterruptManager`.
    *   `[ ]` **Sub-task 3.0.5: Integrate AI decision-making for interrupts.**
        *   **Guidance:** For NPCs, the `InterruptManager` will pass the `Interrupt` object to the AI system, which will decide whether to take the action based on its behavioral flags (e.g., an `aggressive` AI always accepts, a `cautious` AI might decline).
*   `[ ]` **Task 3.1: Implement Attacks of Opportunity (AoO) System.**
    *   `[ ]` **Sub-task 3.1.1:** Implement the core AoO trigger: leaving a threatened square.
    *   `[ ]` **Sub-task 3.1.2:** Implement AoO triggers for combat actions (e.g., making a Ranged Attack while threatened, Unarmed Strikes without the `Improved Unarmed Strike` feat).
    *   `[ ]` **Sub-task 3.1.3:** Implement AoO triggers for general actions (e.g., Casting a Spell, Drinking a Potion, Standing Up from Prone).
    *   `[ ]` **Sub-task 3.1.4:** Implement the AoO economy. An AoO is a special Free Action that does not consume the attacker's normal actions. Implement a per-round counter on each entity to track AoO uses. This counter should be reset at the start of each entity's turn. Ensure an entity cannot take more AoOs than their per-round limit (typically 1, but modified by `Modifiers` from feats like Combat Reflexes).
*   `[x]` **Task 3.2: Implement Terrain Movement Costs.**
*   `[ ]` **Task 3.3: Implement Special Combat Actions.**
    *   `[ ]` **Sub-task 3.3.1:** Implement **Charge** (Full-Round Action).
    *   `[ ]` **Sub-task 3.3.2:** Implement **Trip** (replaces a normal melee attack).
    *   `[ ]` **Sub-task 3.3.3:** Implement **Disarm** (replaces a normal melee attack).
    *   `[ ]` **Sub-task 3.3.4:** Implement **Bull Rush** (Standard Action).
    *   `[ ]` **Sub-task 3.3.5:** Implement **Feint** (Standard Action in combat).
    *   `[ ]` **Sub-task 3.3.6:** Implement **Grapple** (replaces an attack, with special follow-up rules).
*   `[ ]` **Task 3.4: Implement Tactical Actions.**
    *   `[ ]` **Sub-task 3.4.1:** Implement **Aid Another** to help allies with attacks or skills.
    *   `[ ]` **Sub-task 3.4.2:** Implement the **Ready** action (to prepare a Standard Action).
    *   `[ ]` **Sub-task 3.4.3:** Implement the **Total Defense** action (+4 dodge bonus to AC).
    *   `[ ]` **Sub-task 3.4.4:** Implement the **Withdraw** action (Full-Round Action to safely move out of melee).

---
#### **Phase 4: Advanced World Systems (Revised)**
*   `[ ]` **Task 4.1: Implement Modular AI with Behavioral Flags.**
*   `[ ]` **Task 4.2: Implement the Unified Spellbook & Casting System.**
    *   `[ ]` **Sub-task 4.2.1:** Implement **Concentration** checks when taking damage or being affected by distractions while casting.
    *   `[ ]` **Sub-task 4.2.2:** Implement the **"Cast on the Defensive"** option (requires a Concentration check to avoid provoking an AoO).
    *   `[ ]` **Sub-task 4.2.3:** Implement **Touch Spells**, including Melee/Ranged Touch Attacks and the ability to "Hold the Charge".
    *   `[ ]` **Sub-task 4.2.4:** Differentiate spell casting times (Standard Action, Full-Round, Free Action for quickened spells) and their impact on the combat round.
*   `[ ]` **Task 4.3: Implement Advanced Procedural Generation.**
*   `[ ]` **Task 4.4: Implement Saving and Loading.**

---
#### **Phase 5: Systemic Interactions (The NetHack Factor) (Revised)**
*   `[ ]` **Task 5.1: Implement Material Interactions (D&D 3.5e Hardness & NetHack Erosion).**
    *   `[ ]` **Sub-task 5.1.1:** Implement object hardness and hit points based on material (e.g., wood, stone, iron, mithril) as per D&D 3.5e rules.
    *   `[ ]` **Sub-task 5.1.2:** Implement item erosion states (`[state:rusty]`, `[state:corroded]`, `[state:burnt]`, `[state:rotted]`).
    *   `[ ]` **Sub-task 5.1.3:** Implement erosion effects: rusted/corroded items have reduced effectiveness (lower AC for armor, lower damage for weapons).
    *   `[ ]` **Sub-task 5.1.4:** Implement erosion triggers:
        *   Water causes `[state:rusty]` on iron items.
        *   Acid causes `[state:corroded]` on copper and iron items.
        *   Fire causes `[state:burnt]` on flammable items (wood, cloth, leather).
*   `[ ]` **Task 5.2: Implement Environmental Interactions.**
    *   `[ ]` **Sub-task 5.2.1: Implement Flammable Terrain.**
        *   **Guidance:** Fire-based attacks or effects on a tile with the `[flammable]` tag (e.g., "dry grass", "web") should change the tile to "burning grass" and create a damaging hazard.
    *   `[ ]` **Sub-task 5.2.2: Implement Water/Lava Hazards.**
        *   **Guidance:** Entering lava without fire resistance is instant death. Entering with resistance starts a countdown to drowning.
        *   **Guidance:** Unprotected movement in water triggers drowning checks based on Constitution and encumbrance.
    *   `[ ]` **Sub-task 5.2.3: Implement Spell/Environment Interactions.**
        *   **Guidance:** A `cone of cold` spell should freeze a water tile into an `[ice]` tile. A `fireball` spell should melt an `[ice]` tile into a `[water]` tile or evaporate a `[water]` tile into a normal floor tile.
*   `[ ]` **Task 5.3: Implement Item-on-Item Interactions (NetHack's "Dipping").**
    *   `[ ]` **Sub-task 5.3.1:** Refactor `UseItemAction` to optionally accept a second item as a target (`Use(player, item_to_use, target_item)`).
    *   `[ ]` **Sub-task 5.3.2:** Implement potion-dipping mechanics:
        *   Dipping projectiles (arrows, bolts) in a `potion of poison` applies a `[poisoned]` tag and effect.
        *   Dipping a non-magical weapon in a `potion of bless` grants a temporary magical bonus.
    *   `[ ]` **Sub-task 5.3.3:** Implement reagent-like interactions:
        *   Dipping a `unicorn horn` into a `potion of poison` neutralizes it into a `potion of water`.
        *   Dipping an `amethyst` into a `potion of booze` transmutes it into a `potion of fruit juice`.


---
### Online references for D&D 3.5e and the d20 System : 
*   https://www.d20srd.org/index.htm
*   https://www.realmshelps.net
*   https://srd.dndtools.org/
*   http://dndsrd.net/
*   https://dndtools.net
*   https://dnd.arkalseif.info

### Incursion: Halls of the Goblin King references and source code : 
*   https://www.roguebasin.com/index.php/Incursion
*   https://github.com/rmtew/incursion-roguelike

### NetHack references and source code : 
*   https://nethackwiki.com
*   https://github.com/NetHack/NetHack
