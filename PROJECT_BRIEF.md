### **Project Brief: "Eversummer Days" (Working Title) - Revision 4**

**Game Premise:**
*   **Genre:** 2D, Tile-Based, Hybrid Turn-Based Tactical RPG.
*   **Core Philosophy:** A "Fantasy World Simulator" that prioritizes deep, systemic interactivity and emergent gameplay over a linear, scripted narrative. The goal is a highly faithful digital adaptation of the D&D 3.5e OGL ruleset.
*   **Inspiration:** The mechanical depth and rule-based world of **Dungeons & Dragons 3.5e OGL**, the strategic, systems-driven combat of **Incursion**, and the profound emergent interactions and player freedom of **NetHack**.
*   **Setting:** A setting-agnostic fantasy world, intentionally designed as a blank canvas for community-driven content.
*   **Core Gameplay Loop:** Explore dangerous environments, overcome challenges using a wide array of tactical actions and items, engage in turn-based combat governed by a strict ruleset (including flanking and attacks of opportunity), and develop unique characters through a class-based system.

**High-Level Objectives:**
1.  **Build a Systems-First Engine:** The primary goal is to create a robust, bespoke game engine in TypeScript that simulates a fantasy world governed by consistent, interlocking rules. The story and quests are secondary to the quality of the simulation.
2.  **Embrace Emergent Gameplay:** The engine will not script specific outcomes. Instead, it will provide a toolbox of universal actions (`Use`, `Equip`, `Attack`) and a rich set of object properties (tags, materials, curses, magical enchantments). The "gameplay" will emerge from the logical and often surprising interactions between these systems.
3.  **True Plug-and-Play Moddability:** The engine must be a **rules-agnostic interpreter**. Users must be able to add new races, classes, items, spells, and even fundamental game mechanics by simply adding data (`.json`) and logic (`.mjs`) files, without ever recompiling the core engine.
4.  **Flexible Content Generation:** The engine must support both handcrafted, static maps for authored experiences and procedural dungeon generation for infinite replayability, allowing content creators to blend both approaches within a single campaign.

**Key Design Concepts & Technical Requirements:**
*   **Architectural Pillars:**
    *   **Service Locator:** A single, global point of access for all engine systems and the game state, ensuring controlled, explicit dependencies.
    *   **Event Bus:** A central nervous system for decoupled communication, allowing systems to react to game events (like `action:move:provokes_aoo`) without direct knowledge of one another.
    *   **Hybrid Turn System:** A stateful `TurnManager` that seamlessly transitions between real-time "Exploration Mode" and a strict, initiative-based "Combat Mode," correctly handling out-of-turn actions like Attacks of Opportunity.
    *   **Modifier Pipeline:** A sophisticated system (`ModifierManager`, `ModifierList`) for calculating all rolls and statistics by applying `Modifiers` of different types (`racial`, `armor`, `competence`, `untyped`), correctly handling D&D's complex bonus stacking and capping (e.g., Max DEX Bonus) rules.
    *   **Global Tagging System:** A universal metadata system (`tags: string[]`) on all content items and instances to drive rules, validation, and emergent interactions.
*   **Combinatorial Item System:** Items are generated by combining a **base item** (`longsword.json`) with one or more **magic properties** (`flaming.json`, `+1.json`) and **materials** (`adamantine.json`). A `LootFactory` is responsible for this procedural generation, creating immense variety from a small set of data files.
*   **Modular AI with Behavioral Flags:** AI is not monolithic. A single, powerful AI Package acts as a "behavior runner." Monster prefabs specify a list of behavioral flags (`ai_flags: ["FLEER", "ARCHER"]`) that dictate which reusable AI subroutines the runner should execute, allowing for complex AI composition through data.
*   **Unified Entity Model:** All characters (PCs and NPCs) are built from the same fundamental `Entity` class and share the same components (`InventoryComponent`, `EquipmentComponent`), ensuring rules consistency.
*   **Rendering:** An initial ASCII/character-based rendering on HTML5 Canvas, driven by a `Renderable` component for maximum flexibility and decoupling.

---

### **Implementation Checklist: The Path to MVP and Beyond (Revision 5)**

#### **Phase 0: Architecture Complete**
*   `[x]` **Implement the Global Tagging System.**
*   `[x]` **Build the Core `RulesEngine` Service.**
*   `[x]` **Implement the Service Locator Pattern.**
*   `[x]` **Decouple and Refactor the UI.**
*   `[x]` **Implement the `Renderable` Component.**
*   `[x]` **Unify NPCs with an `NpcFactory`.**
*   `[x]` **Build the `TurnManager`.**
*   `[x]` **Implement Full Feat & Ability Application.**
*   `[x]` **Formalize the Action Economy.**

---
#### **Phase 1: Character & Action Systems Online**
*   `[x]` **Action Economy Framework Established.**
*   `[x]` **Feat & Ability Application Implemented.**
*   `[x]` **"Attack" Action Chain Implemented.**
*   `[x]` **Full Damage Calculation Implemented.**
*   `[x]` **Critical Hits Implemented.**
*   `[x]` **Modular AI Execution Implemented (Initial Refactor).**
*   `[x]` **Movement Point System Implemented.**
    *   **Status:** Done. The `TurnManager` now grants movement points, and the `RulesEngine` deducts them based on tile cost.

---
#### **Phase 2: Deep Equipment & Itemization**
*   `[x]` **Task 2.1: Implement the Full Equipment System.**
    *   **Status:** Done. `EquipmentComponent` now handles proficiency checks and data-driven modifier application.
*   `[x]` **Task 2.2: Implement Combinatorial Item Generation (`LootFactory`).**
    *   **Status:** Done. `LootFactory` can combine base items, magic properties, and materials. `NpcFactory` now uses it.
*   `[ ]` **Task 2.3: Implement the "Use Item" Action.**
*   `[ ]` **Task 2.4: Implement Item Identification.**
*   `[ ]` **Task 2.5: Implement Item States via Tags.**

---
#### **Phase 3: Advanced Combat Tactics**
*   `[ ]` **Task 3.1: Implement Attacks of Opportunity (AoO).**
    *   **Guidance:** Implement the `action:move:provokes_aoo` event and handler in the `RulesEngine`. An AoO is a single, free melee attack that happens immediately, interrupting the move.
*   `[x]` **Task 3.2: Implement Terrain Movement Costs.**
    *   **Status:** Done. `tileDefinitions.json` now includes `moveCost`, which is used by the `RulesEngine`.

---
#### **Phase 4: Advanced World Systems**
*   `[ ]` **Task 4.1: Implement Modular AI with Behavioral Flags.**
    *   **Guidance:** Create a library of small AI behavior scripts (`FleeWhenWounded.mjs`, `UseRangedAttack.mjs`). Create a single `standardAI.mjs` "behavior runner" that reads an `ai_flags: ["FLEER", "ARCHER"]` array from monster prefabs and executes the corresponding behaviors in sequence.
*   `[ ]` **Task 4.2: Implement the Unified Spellbook.**
*   `[ ]` **Task 4.3: Implement Advanced Procedural Generation.**
    *   **Guidance:** Create a `MapGenerator` service for procedural maps. It must also handle procedural placement of items (using loot tables per dungeon level) and monsters (using challenge ratings to create appropriate encounters).
*   `[ ]` **Task 4.4: Implement Saving and Loading.**

---
#### **Phase 5: Systemic Interactions (The NetHack Factor)**
*   `[ ]` **Task 5.1: Implement Material Interactions.**
    *   **Guidance:** Use the event bus and tagging system. Create a listener that checks for `action:damage:resolved`. If a weapon with the `[slashing]` tag hits a creature with the `[material:wood]` tag, the creature takes extra damage. If a monster attack with `[acid]` hits a player wearing armor with the `[material:iron]` tag, the armor's `armor_bonus` modifier should be permanently reduced.
*   `[ ]` **Task 5.2: Implement Environmental Interactions.**
    *   **Guidance:** A `fire` spell hitting a `[flammable]` tile (e.g., "dry grass") should change the tile type to "burning grass" and apply damage to any creature standing on it at the end of their turn.
*   `[ ]` **Task 5.3: Implement Item-on-Item Interactions.**
    *   **Guidance:** Refactor the `UseItemAction` to optionally take a second target (`targetItem`). This would allow for actions like `Use(player, potion_of_healing, sword)`, which could apply a temporary poison to the weapon. This is the foundation for NetHack's "dipping" mechanic.


---
### Online references for D&D 3.5e : 
*   https://www.d20srd.org/index.htm
*   https://www.realmshelps.net
*   https://srd.dndtools.org/
*   http://dndsrd.net/
*   https://dndtools.net
*   https://dnd.arkalseif.info

### Incursion d20 references and source code : 
*   https://www.roguebasin.com/index.php/Incursion
*   https://github.com/rmtew/incursion-roguelike

### NetHack references and source code : 
*   https://nethackwiki.com
*   https://github.com/NetHack/NetHack