### **Project Brief: "Eversummer Days" (Working Title) - Revision 5**

**Game Premise:**
*   **Genre:** 2D, Tile-Based, Hybrid Turn-Based Tactical RPG.
*   **Core Philosophy:** A "Fantasy World Simulator" that prioritizes deep, systemic interactivity and emergent gameplay over a linear, scripted narrative. The goal is a highly faithful digital adaptation of the D&D 3.5e OGL ruleset.
*   **Inspiration:** The mechanical depth and rule-based world of **Dungeons & Dragons 3.5e OGL**, the strategic, systems-driven combat of **Incursion: Halls of the Goblin King**, and the profound emergent interactions and player freedom of **NetHack**.
*   **Setting:** A setting-agnostic fantasy world, intentionally designed as a blank canvas for community-driven content.
*   **Core Gameplay Loop:** Explore dangerous environments, overcome challenges using a wide array of tactical actions and items, engage in turn-based combat governed by a strict ruleset (including flanking and attacks of opportunity), and develop unique characters through a class-based system.

**High-Level Objectives:**
1.  **Build a Systems-First Engine:** The primary goal is to create a robust, bespoke game engine in TypeScript that simulates a fantasy world governed by consistent, interlocking rules. The story and quests are secondary to the quality of the simulation.
2.  **Embrace Emergent Gameplay:** The engine will not script specific outcomes. Instead, it will provide a toolbox of universal actions (`Use`, `Equip`, `Attack`) and a rich set of object properties (tags, materials, curses, magical enchantments). The "gameplay" will emerge from the logical and often surprising interactions between these systems.
3.  **True Plug-and-Play Moddability:** The engine is designed for **maximum moddability within the D&D 3.5e OGL ruleset**. Users must be able to add new races, classes, items, spells, and even fundamental game mechanics by simply adding data (`.json`) files that conform to defined schemas and companion logic (`.mjs`) files. The **Unified Effect System** ensures all content is processed consistently, maximizing customizability without recompiling the core engine.
4.  **Flexible Content Generation:** The engine must support both handcrafted, static maps for authored experiences and procedural dungeon generation for infinite replayability, allowing content creators to blend both approaches within a single campaign.

**Key Design Concepts & Technical Requirements:**
*   **Architectural Pillars:**
    *   **Data-Driven Logic with Scripting Hooks:** The engine favors a declarative approach, avoiding hardcoded behaviors wherever possible, while strictly adhering to D&D 3.5e principles. The **Unified Effect System** serves as the primary mechanism for this, defining all character abilities, bonuses, and proficiencies in data (`.json`) files. Complex, unique behaviors are implemented in companion script files (`.mjs`) referenced by these effects. This ensures the engine's hardcoded systems remain generic and reusable, maximizing modability for all features and content within the D&D 3.5e context.
    *   **Service Locator:** A single, global point of access for all engine systems and the game state, ensuring controlled, explicit dependencies.
    *   **Event Bus:** A central nervous system for decoupled communication, allowing systems to react to game events (like `action:move:provokes_aoo`) without direct knowledge of one another.
    *   **Hybrid Turn System:** A stateful `TurnManager` that seamlessly transitions between two distinct turn-based modes: a "WeGo" system for simultaneous-resolution **Exploration Mode**, and a strict, initiative-based system for sequential-action **Combat Mode**. This ensures fluid exploration while preserving the tactical, out-of-turn actions (like Attacks of Opportunity) that are exclusive to combat.
    *   **Modifier Pipeline:** A sophisticated system (`ModifierManager`, `ModifierList`) for calculating all rolls and statistics by applying `Modifiers` of different types (`racial`, `armor`, `competence`, `untyped`) in 3 layers (inherent/base, permanent, temporary), correctly handling D&D's complex bonus stacking and capping (e.g., Max DEX Bonus) rules.
    *   **Global Tagging System:** A universal metadata system (`tags: string[]`) on all content items and instances to drive rules, validation, and emergent interactions.
*   **Combinatorial Item System:** Items are generated by combining a **base item** (`longsword.json`) with one or more **magic properties** (`flaming.json`, `+1.json`) and **materials** (`adamantine.json`). A `LootFactory` is responsible for this procedural generation, creating immense variety from a small set of data files.
*   **Modular AI with Behavioral Flags:** AI is not monolithic. A single, powerful AI Package acts as a "behavior runner." Monster prefabs specify a list of behavioral flags (`ai_flags: ["FLEER", "ARCHER"]`) that dictate which reusable AI subroutines the runner should execute, allowing for complex AI composition through data.
*   **Unified Entity Model:** All characters (PCs and NPCs) are built from the same fundamental `Entity` class and share the same components (`InventoryComponent`, `EquipmentComponent`), ensuring rules consistency.
*   **Rendering:** An initial ASCII/character-based rendering on HTML5 Canvas, driven by a `Renderable` component for maximum flexibility and decoupling.

---

### **Implementation Checklist: The Path to MVP and Beyond (Revision 7)**

#### **Phase 0: Core Engine Architecture**
*   `[x]` **Task 0.1: Foundational Systems.**
    *   **Status:** Complete. Implemented the `ServiceLocator`, `EventBus`, `TurnManager`, `RulesEngine`, `Renderable` component, `NpcFactory`, and the global `Tagging` system.
*   `[x]` **Task 0.2: Standardize Content with a Unified Effect System.**
    *   **Principle:** All character abilities, bonuses, and proficiencies, regardless of their source (race, class, feats, items), are defined as `effects`. This creates a single, predictable data structure for the engine to process, moving away from disparate properties like `bonuses` or `special_abilities`.
    *   `[x]` **Sub-task 0.2.1: Create JSON Schemas for all Content Types.**
        *   **Status:** Done. Created `race.schema.json`, `class.schema.json`, `feat.schema.json`, `skill.schema.json`, and `template.schema.json`. These enforce the unified `effects` array structure.
*   `[x]` **Task 0.3: Implement the Modifier Pipeline.**
    *   **Principle:** Character statistics are not stored as fixed values but are calculated dynamically at runtime. The **Modifier Pipeline** is the system responsible for this calculation. It starts with a base value (e.g., Strength score of 10) and applies a series of `Modifiers` from all active sources (race, feats, equipment, spell effects) to produce the final, in-the-moment value. This ensures all bonuses and penalties are accounted for and correctly stacked according to D&D 3.5e rules.
    *   `[x]` **Sub-task 0.3.1: Implement Data-Driven Modifier Types.**
        *   **Guidance:** The behavior of modifiers must be data-driven. Create `modifier_types.json` to define types like `racial`, `enhancement`, and `dodge`, specifying their stacking behavior (e.g., `stacking: 'sum'` or `stacking: 'highest'`). The `ModifierManager` will use this data to correctly calculate totals.
    *   `[x]` **Sub-task 0.3.2: Implement the `ModifierManager` Service.**
        *   **Guidance:** Build the central service that manages all active modifiers for an entity. It will expose methods like `addModifier()`, `removeModifier()`, and `getValue(targetStat)`.
    *   `[x]` **Sub-task 0.3.3: Centralize Stat Calculation in the `Entity` Class.**
        *   **Guidance:** Refactor the `Entity` class to be the single point of truth for all stats. Create getter methods (e.g., `getStrength()`, `getFortitudeSave()`) that combine the entity's base value with the final calculated value from the `ModifierManager`.
    *   `[x]` **Sub-task 0.3.4: Integrate the Pipeline with all Game Systems.**
        *   **Guidance:** Refactor the engine to use the new pipeline.
        *   The `RulesEngine` will be responsible for applying **permanent** modifiers from race, class, and feats during character creation (`calculateStats`).
        *   The `EffectManager` will be responsible for applying and removing **temporary** modifiers from spells and item abilities.
        *   The `EquipmentComponent` will apply and remove modifiers when items are equipped or unequipped.

---
#### **Phase 1: Core Actions & Combat**
*   `[x]` **Task 1.1: Action & Combat Basics.**
    *   **Status:** Complete. Implemented the Action Economy, Attack action, damage calculation, critical hits, and the movement system.
*   `[x]` **Task 1.2: Implement Attacks of Opportunity (AoO).**
    *   **Status:** Complete. The `InterruptManager` now correctly handles AoOs triggered by movement, ranged attacks, spellcasting, and other actions. The per-round AoO economy is also functional.
*   `[ ]` **Task 1.3: Implement Special & Tactical Combat Actions.**
    *   `[ ]` **Sub-task 1.3.1:** Implement Special Attacks (Charge, Trip, Disarm, Bull Rush, Feint, Grapple).
    *   `[ ]` **Sub-task 1.3.2:** Implement Tactical Actions (Aid Another, Ready, Total Defense, Withdraw).

---
#### **Phase 2: Itemization & Skill Systems**
*   `[x]` **Task 2.1: Item & Skill Basics.**
    *   **Status:** Complete. Implemented the equipment system, combinatorial item generation (`LootFactory`), the "Use Item" action, item identification, and item states via tags.
*   `[x]` **Task 2.2: Implement Data-Driven Skill Usage.**
    *   **Status:** Complete. Skills are now defined in JSON with `active_uses`, and the `RulesEngine` can resolve skill checks based on this data via the `UseSkillAction`.
*   `[x]` **Task 2.3: Implement the Unified Power System.**
    *   **Status:** Complete. Implemented a generic system for selecting and using powers (spells, etc.), including Concentration checks, casting on the defensive, and touch-based powers.

---
#### **Phase 3: Character Creation & Progression**
*   `[x]` **Task 3.1: Finalize the Character Creation Pipeline.**
    *   **Status:** Complete. All core systems for character creation are in place, including class selection, feat prerequisite checking, template application, equipment purchasing, and correct calculation of derived stats (HP, skill points) based on race and class.

---
#### **Phase 4: Advanced Systems**
*   `[ ]` **Task 4.1: Implement Modular AI with Behavioral Flags.**
*   `[ ]` **Task 4.2: Implement Systemic Interactions (The NetHack Factor).**
    *   `[ ]` **Sub-task 4.2.1:** Implement Material Interactions (Hardness & Erosion).
    *   `[ ]` **Sub-task 4.2.2:** Implement Environmental Interactions (Flammable terrain, Water/Lava hazards, Spell combos).
    *   `[ ]` **Sub-task 4.2.3:** Implement Item-on-Item Interactions (Dipping).

---
#### **Phase 5: Core Content Implementation**
*   `[x]` **Task 5.1: Implement & Refactor Core SRD Content.**
    *   **Status:** Done. Created and refactored the initial set of SRD races, classes, feats, and templates to conform to the new JSON schemas and unified `effects` system.

---
#### **Phase 6: Maintenance & Bugfixes**
*   `[x]` **Task 6.1: Fix Feat Selection Bug.**
    *   **Status:** Complete. Resolved an issue where feats were not being correctly selected or displayed in the character creation UI. The root cause was that content items were not being assigned a unique `id` during the loading process, causing the selection logic to fail.

---
### Online references for D&D 3.5e and the d20 System : 
*   https://www.d20srd.org/index.htm
*   https://www.realmshelps.net
*   https://srd.dndtools.org/
*   https://dndtools.net
*   https://dnd.arkalseif.info

### Incursion: Halls of the Goblin King references and source code : 
*   https://www.roguebasin.com/index.php/Incursion
*   https://github.com/rmtew/incursion-roguelike

### NetHack references and source code : 
*   https://nethackwiki.com
*   https://github.com/NetHack/NetHack
